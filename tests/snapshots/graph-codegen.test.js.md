# Snapshot report for `tests/graph-codegen.test.js`

The actual snapshot is saved in `graph-codegen.test.js.snap`.

Generated by [AVA](https://avajs.dev).

## netlify graph function codegen

> Snapshot 1

    '{"clientSource":"// GENERATED VIA `netlify-plugin-netligraph`, EDIT WITH CAUTION!/nconst https = require(/"https/")/nconst crypto = require(/"crypto/")/n/nexports.verifySignature = (input) => {/n  const secret = input.secret/n  const body = input.body/n  const signature = input.signature/n/n  if (!signature) {/n    console.error(\'Missing signature\')/n    return false/n  }/n/n  const sig = {}/n  for (const pair of signature.split(\',\')) {/n    const [k, v] = pair.split(\'=\')/n    sig[k] = v/n  }/n/n  if (!sig.t || !sig.hmac_sha256) {/n    console.error(\'Invalid signature header\')/n    return false/n  }/n/n  const hash = crypto/n    .createHmac(\'sha256\', secret)/n    .update(sig.t)/n    .update(\'.\')/n    .update(body)/n    .digest(\'hex\')/n/n  if (/n    !crypto.timingSafeEqual(/n      Buffer.from(hash, \'hex\'),/n      Buffer.from(sig.hmac_sha256, \'hex\')/n    )/n  ) {/n    console.error(\'Invalid signature\')/n    return false/n  }/n/n  if (parseInt(sig.t, 10) < Date.now() / 1000 - 300 /* 5 minutes */) {/n    console.error(\'Request is too old\')/n    return false/n  }/n/n  return true/n}/n/nconst operationsDoc = `query ExampleQuery($package: String!) @netligraph(id: /"d88888fb-ddfc-4833-9d9a-f3497cb7c992/", doc: /"A test query to snapshot/") {/n  npm {/n    package(name: $package) {/n      id/n      readme/n      license {/n        url/n      }/n    }/n  }/n}`/n/n/nconst fetch = (appId, options) => {/n  var reqBody = options.body || null/n  const userHeaders = options.headers || {}/n  const headers = {/n    ...userHeaders,/n    \'Content-Type\': \'application/json\',/n    \'Content-Length\': reqBody.length,/n  }/n/n  var reqOptions = {/n    method: \'POST\',/n    headers: headers,/n    timeout: 88888,/n  }/n/n  const url = \'https://serve.onegraph.com/graphql?app_id=\' + appId/n/n  const respBody = []/n/n  return new Promise((resolve, reject) => {/n    var req = https.request(url, reqOptions, (res) => {/n      if (res.statusCode < 200 || res.statusCode > 299) {/n        return reject(/n          new Error(/n            /"Netlify OneGraph return non - OK HTTP status code/" + res.statusCode,/n          ),/n        )/n      }/n/n      res.on(\'data\', (chunk) => respBody.push(chunk))/n/n      res.on(\'end\', () => {/n        const resString = Buffer.concat(respBody).toString()/n        resolve(resString)/n      })/n    })/n/n    req.on(\'error\', (e) => {/n      console.error(\'Error making request to Netlify OneGraph: \', e)/n    })/n/n    req.on(\'timeout\', () => {/n      req.destroy()/n      reject(new Error(\'Request to Netlify OneGraph timed out\'))/n    })/n/n    req.write(reqBody)/n    req.end()/n  })/n}/n/nconst fetchOneGraphPersisted = async function fetchOneGraphPersisted(/n  accessToken,/n  docId,/n  operationName,/n  variables,/n) {/n  const payload = {/n    doc_id: docId,/n    variables: variables,/n    operationName: operationName,/n  }/n/n  const result = await fetch(/n    process.env.SITE_ID,/n    {/n      method: \'POST\',/n      headers: {/n        Authorization: accessToken ? /"Bearer /" + accessToken : \'\',/n      },/n      body: JSON.stringify(payload),/n    },/n  )/n/n  // @ts-ignore/n  return JSON.parse(result)/n}/n/nconst fetchOneGraph = async function fetchOneGraph(/n  accessToken,/n  query,/n  operationName,/n  variables,/n) {/n  const payload = {/n    query: query,/n    variables: variables,/n    operationName: operationName,/n  }/n/n  const result = await fetch(/n    process.env.SITE_ID,/n    {/n      method: \'POST\',/n      headers: {/n        Authorization: accessToken ? /"Bearer /" + accessToken : \'\',/n      },/n      body: JSON.stringify(payload),/n    },/n  )/n/n  // @ts-ignore/n  return JSON.parse(result)/n}/n/n/nexports.verifyRequestSignature = (request) => {/n  const event = request.event/n  const secret = process.env.NETLIGRAPH_WEBHOOK_SECRET/n  const signature = event.headers[\'x-onegraph-signature\']/n  const body = event.body/n/n  if (!secret) {/n    console.error(/n      \'NETLIGRAPH_WEBHOOK_SECRET is not set, cannot verify incoming webhook request\'/n    )/n    return false/n  }/n/n  return verifySignature({ secret, signature, body: body || \'\' })/n}/n/nexports.fetchExampleQuery = (/n  variables,/n  accessToken,/n) => {/n  // return fetchOneGraphPersisted(accessToken, /"d88888fb-ddfc-4833-9d9a-f3497cb7c992/", /"ExampleQuery/", variables)/n  return fetchOneGraph(accessToken, operationsDoc, /"ExampleQuery/", variables)/n}/n/n/n  /n/**/n * The generated Netligraph library with your operations/n *//nconst functions = {/n  /**/n  * A test query to snapshot/n  *//n  fetchExampleQuery: exports.fetchExampleQuery/n}/n/nexports.default = functions/n/nexports.handler = async (event, context) => {/n  // return a 401 json response/n  return {/n    statusCode: 401,/n    body: JSON.stringify({/n      message: \'Unauthorized\',/n    }),/n  }/n}","typeDefinitionsSource":"// GENERATED VIA `netlify-plugin-netligraph`, EDIT WITH CAUTION!/n/**/n * A test query to snapshot/n *//nexport function fetchExampleQuery(/n  variables: {/n  package: string/n},/n  accessToken?: string/n): Promise</n  {/n/**/n* Any data retrieved by the function be returned here/n*//n data?: {/n      /n/**/n* The root for npm queries/n*//n npm: {/n      /n/**/n* Find a npm package member by its npm name, e.g. `/"fela/"`/n*//n package?: {/n      /n/**/n* The package name, used as an ID in CouchDB/n*//n id?: string; /n/**/n* The first 64K of the README data for the most-recently published version of the package/n*//n readme?: string; /n/**/n* The license for this package/n*//n license: {/n      /n/**/n* A url for the full license/n*//n url?: string/n  }/n  }/n  }/n  }; /n/**/n* Any errors in the function will be returned here/n*//n errors?: Array<any>}/n>;/n","functionDefinitions":[{"id":"d88888fb-ddfc-4833-9d9a-f3497cb7c992","definition":"query ExampleQuery($package: String!) @netligraph(id: /"d88888fb-ddfc-4833-9d9a-f3497cb7c992/", doc: /"A test query to snapshot/") {/n  npm {/n    package(name: $package) {/n      id/n      readme/n      license {/n        url/n      }/n    }/n  }/n}","description":"A test query to snapshot","fnName":"fetchExampleQuery","safeBody":"query ExampleQuery($package: String!) @netligraph(id: /"d88888fb-ddfc-4833-9d9a-f3497cb7c992/", doc: /"A test query to snapshot/") {/n  npm {/n    package(name: $package) {/n      id/n      readme/n      license {/n        url/n      }/n    }/n  }/n}","kind":"query","variableSignature":"{/n  package: string/n}","returnSignature":"{/n/**/n* Any data retrieved by the function be returned here/n*//n data?: {/n      /n/**/n* The root for npm queries/n*//n npm: {/n      /n/**/n* Find a npm package member by its npm name, e.g. `/"fela/"`/n*//n package?: {/n      /n/**/n* The package name, used as an ID in CouchDB/n*//n id?: string; /n/**/n* The first 64K of the README data for the most-recently published version of the package/n*//n readme?: string; /n/**/n* The license for this package/n*//n license: {/n      /n/**/n* A url for the full license/n*//n url?: string/n  }/n  }/n  }/n  }; /n/**/n* Any errors in the function will be returned here/n*//n errors?: Array<any>}","operationName":"ExampleQuery","parsedOperation":{"kind":"OperationDefinition","operation":"query","name":{"kind":"Name","value":"ExampleQuery","loc":{"start":6,"end":18}},"variableDefinitions":[{"kind":"VariableDefinition","variable":{"kind":"Variable","name":{"kind":"Name","value":"package","loc":{"start":20,"end":27}},"loc":{"start":19,"end":27}},"type":{"kind":"NonNullType","type":{"kind":"NamedType","name":{"kind":"Name","value":"String","loc":{"start":29,"end":35}},"loc":{"start":29,"end":35}},"loc":{"start":29,"end":36}},"directives":[],"loc":{"start":19,"end":36}}],"directives":[{"kind":"Directive","name":{"kind":"Name","value":"netligraph","loc":{"start":39,"end":49}},"arguments":[{"kind":"Argument","name":{"kind":"Name","value":"id","loc":{"start":50,"end":52}},"value":{"kind":"StringValue","value":"d88888fb-ddfc-4833-9d9a-f3497cb7c992","block":false,"loc":{"start":54,"end":92}},"loc":{"start":50,"end":92}},{"kind":"Argument","name":{"kind":"Name","value":"doc","loc":{"start":94,"end":97}},"value":{"kind":"StringValue","value":"A test query to snapshot","block":false,"loc":{"start":99,"end":125}},"loc":{"start":94,"end":125}}],"loc":{"start":38,"end":126}}],"selectionSet":{"kind":"SelectionSet","selections":[{"kind":"Field","name":{"kind":"Name","value":"npm","loc":{"start":131,"end":134}},"arguments":[],"directives":[],"selectionSet":{"kind":"SelectionSet","selections":[{"kind":"Field","name":{"kind":"Name","value":"package","loc":{"start":141,"end":148}},"arguments":[{"kind":"Argument","name":{"kind":"Name","value":"name","loc":{"start":149,"end":153}},"value":{"kind":"Variable","name":{"kind":"Name","value":"package","loc":{"start":156,"end":163}},"loc":{"start":155,"end":163}},"loc":{"start":149,"end":163}}],"directives":[],"selectionSet":{"kind":"SelectionSet","selections":[{"kind":"Field","name":{"kind":"Name","value":"id","loc":{"start":173,"end":175}},"arguments":[],"directives":[],"loc":{"start":173,"end":175}},{"kind":"Field","name":{"kind":"Name","value":"readme","loc":{"start":182,"end":188}},"arguments":[],"directives":[],"loc":{"start":182,"end":188}},{"kind":"Field","name":{"kind":"Name","value":"license","loc":{"start":195,"end":202}},"arguments":[],"directives":[],"selectionSet":{"kind":"SelectionSet","selections":[{"kind":"Field","name":{"kind":"Name","value":"url","loc":{"start":213,"end":216}},"arguments":[],"directives":[],"loc":{"start":213,"end":216}}],"loc":{"start":203,"end":224}},"loc":{"start":195,"end":224}}],"loc":{"start":165,"end":230}},"loc":{"start":141,"end":230}}],"loc":{"start":135,"end":234}},"loc":{"start":131,"end":234}}],"loc":{"start":127,"end":236}},"loc":{"start":0,"end":236}}}]}'

## netlify graph handler codegen

> Snapshot 1

    '{"source":"const { getSecrets } = require(/"@sgrove/netlify-functions/");/nconst Netligraph = require(/"./netligraph/")/n/nexports.handler = async (event, context) => {/n  // By default, all API calls use no authentication/n  let accessToken = null;/n/n  //// If you want to use the client\'s accessToken when making API calls on the user\'s behalf:/n  // accessToken = event.headers[/"authorization/"]?.split(/" /")[1]/n/n  //// If you want to use the API with your own access token:/n  // accessToken = (await getSecrets(event))?.oneGraph?.bearerToken;/n      /n  const eventBodyJson = JSON.parse(event.body || /"{}/");/n/n  const _package = event.queryStringParameters?.package;/n/n  if (_package === undefined || _package === null) {/n    return {/n      statusCode: 422,/n      body: JSON.stringify({/n        error: \'You must supply parameters for: `package`\'/n      }),/n    };/n  }/n/n  const { errors: ExampleQueryErrors, data: ExampleQueryData } =/n    await Netligraph.fetchExampleQuery({ package: _package }, accessToken);/n/n  if (ExampleQueryErrors) {/n    console.error(JSON.stringify(ExampleQueryErrors, null, 2));/n  }/n/n  console.log(JSON.stringify(ExampleQueryData, null, 2));/n/n  return {/n    statusCode: 200,/n    body: JSON.stringify({/n      success: true,/n      ExampleQueryErrors: ExampleQueryErrors,/n      ExampleQueryData: ExampleQueryData/n    }),/n    headers: {/n      \'content-type\': \'application/json\',/n    },/n  };/n};/n/n/** /n * Client-side invocations:/n * Call your Netlify function from the browser (after saving/n * the code to `ExampleQuery.mjs`) with these helpers:/n *//n/n/**/nasync function fetchExampleQuery(params) {/n  const {package} = params || {};/n  const resp = await fetch(`/.netlify/functions/ExampleQuery?package=${package}`,/n    {/n      method: /"GET/"/n    });/n/n    const text = await resp.text();/n/n    return JSON.parse(text);/n}/n*//n/n","operation":{"id":"d88888fb-ddfc-4833-9d9a-f3497cb7c992","name":"ExampleQuery","description":"A test query to snapshot","operation":"query","query":"query ExampleQuery($package: String!) @netligraph(id: /"d88888fb-ddfc-4833-9d9a-f3497cb7c992/", doc: /"A test query to snapshot/") {/n  npm {/n    package(name: $package) {/n      id/n      readme/n      license {/n        url/n      }/n    }/n  }/n}"}}'
